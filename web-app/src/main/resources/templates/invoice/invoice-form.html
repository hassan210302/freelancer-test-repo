<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <th:block th:replace="~{fragments/r-combobox :: r-combobox-dependencies}"></th:block>
</head>
<body>
<main layout:fragment="content">
    <form id="invoiceForm">
        <div class="wa-stack">
            <wa-card>
                <div slot="header">Customer</div>
                <div style="max-width: 300px">
                    <div th:replace="fragments/customer-search :: customerSearch"></div>
                    <wa-input name="customerId" id="customerId" class="wa-visually-hidden"
                              tabindex="-1"></wa-input>
                </div>
            </wa-card>
            <wa-card>
                <div slot="header">Date</div>
                <div class="wa-cluster wa-gap-s">
                    <wa-input id="invoiceDate" name="issueDate" type="date" label="invoice date"
                              size="small"></wa-input>
                    <wa-input id="daysUntilDue" value="14" min="0" size="small"
                              label="days until due" type="number"></wa-input>
                    <wa-input name="dueDate" required id="dueDate" class="wa-visually-hidden"
                              tabindex="-1"></wa-input>
                </div>
            </wa-card>
            <wa-card style="overflow: auto">
                <div slot="header">Lines</div>
                <table id="invoiceTable">
                    <thead>
                    <tr>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Unit Price</th>
                        <th>Discount (%)</th>
                        <th>VAT (%)</th>
                        <th>Amount (Incl. VAT)</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="invoiceBody">
                    <tr>
                        <td>
                            <wa-input size="small" style="width: 300px;" name="itemName"></wa-input>
                        </td>
                        <td>
                            <wa-input type="number" min="0" value="1" size="small" style="width: 80px;"
                                      name="quantity"></wa-input>
                        </td>
                        <td>
                            <wa-input type="number" min="0" value="0" size="small" style="width: 120px;"
                                      name="unitPrice"></wa-input>
                        </td>
                        <td>
                            <wa-input type="number" min="0" value="0" size="small" style="width: 80px;"
                                      name="discount"></wa-input>
                        </td>
                        <td>
                            <r-combobox placeholder="Select VAT code..."
                                        style="font-size: var(--wa-font-size-xs);"></r-combobox>
                            <wa-input name="vatCode" type="number" value="0" class="wa-visually-hidden"
                                      tabindex="-1"></wa-input>
                        </td>
                        <td class="amount">0.00</td>
                        <td>
                            <wa-button size="small" variant="neutral" data-action="duplicate">
                                <wa-icon label="duplicate" name="copy" variant="solid" title="Duplicate"></wa-icon>
                            </wa-button>
                            <wa-button size="small" variant="danger" data-action="delete">
                                <wa-icon label="delete" name="trash" variant="solid" title="Delete"></wa-icon>
                            </wa-button>
                        </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="7" style="text-align: left;">
                            <wa-button type="button" variant="neutral" data-action="add-row">+ Add Row</wa-button>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </wa-card>
            <wa-input name="currencyCode" value="NOK" class="wa-visually-hidden" tabindex="-1"></wa-input>
            <wa-button type="submit" variant="success" style="width: fit-content">Submit Invoice</wa-button>
        </div>
    </form>
</main>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        let vatCodes = [];
    </script>
    <script th:src="@{/assets/cache-config.js}"></script>
    <script th:src="@{/assets/vat-codes.js}"></script>
    <script th:src="@{/assets/fragments/customer-search.js}"></script>

    <script th:inline="javascript">
        const getInputValue = (input) =>
            input?.shadowRoot?.querySelector('input')?.value
            || input?.value
            || input?.getAttribute('value')
            || '';

        const getValue = (row, name) => {
            const input = row.querySelector(`wa-input[name="${name}"]`);
            return parseFloat(getInputValue(input)) || 0;
        };

        const updateAmount = (row) => {
            const qty = getValue(row, 'quantity');
            const price = getValue(row, 'unitPrice');
            const discount = getValue(row, 'discount');
            const vatCode = getValue(row, 'vatCode');
            const vatRate = vatCodes.find(v => Number(v.code) === vatCode)?.rate ?? 0;
            const subtotal = qty * price * (1 - discount / 100);
            const total = subtotal * (1 + vatRate / 100);
            row.querySelector('.amount').textContent = total.toFixed(2);
        };

        const setupRow = (row) => {
            const combobox = row.querySelector('r-combobox');
            if (combobox) {
                combobox.items = vatCodes.map(v => ({
                    value: v.code,
                    title: v.code,
                    subtitle: `${v.rate}% - ${v.description}`,
                    displayText: `${v.code} (${v.rate}%) - ${v.description}`
                }));
                combobox.addEventListener('change', (e) => {
                    const vatCodeInput = row.querySelector('wa-input[name="vatCode"]');
                    vatCodeInput.value = e.detail.value;
                    updateAmount(row);
                });
            }
            updateAmount(row);
        };

        const cloneRow = (sourceRow) => {
            const clone = sourceRow.cloneNode(true);
            clone.querySelectorAll('wa-input').forEach(input => {
                const name = input.getAttribute('name');
                if (name === 'itemName') input.setAttribute('value', '');
                else if (name === 'quantity') input.setAttribute('value', '1');
                else input.setAttribute('value', '0');
            });
            clone.querySelector('r-combobox')?.setAttribute('value', '');
            clone.querySelector('.amount').textContent = '0.00';
            return clone;
        };

        const initInvoiceForm = async () => {
            const form = document.getElementById('invoiceForm');
            const tbody = document.getElementById('invoiceBody');
            const invoiceDateInput = document.getElementById('invoiceDate');
            const daysInput = document.getElementById('daysUntilDue');
            const dueDateInput = document.getElementById('dueDate');

            const getInvoiceDate = () =>
                invoiceDateInput.value ? new Date(invoiceDateInput.value) : new Date();

            const getDaysUntilDue = () =>
                parseInt(daysInput.value || daysInput.getAttribute('value') || '0', 10) || 0;

            const updateDueDate = () => {
                const date = new Date(getInvoiceDate());
                date.setDate(date.getDate() + getDaysUntilDue());
                dueDateInput.value = date.toISOString().slice(0, 10);
                daysInput.setAttribute('label', `days until due: ${date.toLocaleDateString()}`);
            };

            if (!invoiceDateInput.value)
                invoiceDateInput.value = new Date().toISOString().split('T')[0];

            updateDueDate();
            invoiceDateInput.addEventListener('change', updateDueDate);
            daysInput.addEventListener('input', updateDueDate);

            vatCodes = await window.getVatCodes();

            tbody.querySelectorAll('tr').forEach(setupRow);

            form.addEventListener('submit', (event) => {
                event.preventDefault();
                const formData = new FormData();

                ['issueDate', 'dueDate', 'currencyCode', 'customerId', 'supplierId'].forEach(name => {
                    const input = form.querySelector(`wa-input[name="${name}"]`);
                    const value = getInputValue(input);
                    if (value !== '') formData.append(name, value);
                });

                tbody.querySelectorAll('tr').forEach((row, index) => {
                    ['itemName', 'quantity', 'unitPrice', 'discount', 'vatCode'].forEach(field => {
                        const input = row.querySelector(`wa-input[name="${field}"]`);
                        const value = getInputValue(input);
                        if (value !== '') {
                            formData.append(`invoiceLines[${index}].${field}`, value);
                        }
                    });
                });

                htmx.ajax('POST', '/htmx/invoice', {values: formData});
            });

            tbody.addEventListener('input', e => {
                if (e.target.closest('wa-input')) {
                    const row = e.target.closest('tr');
                    updateAmount(row);
                }
            });

            form.querySelector('[data-action="add-row"]').addEventListener('click', () => {
                const newRow = cloneRow(tbody.querySelector('tr'));
                tbody.appendChild(newRow);
                setupRow(newRow);
            });

            tbody.addEventListener('click', (e) => {
                const btn = e.target.closest('wa-button');
                if (!btn) return;

                const row = btn.closest('tr');
                const action = btn.getAttribute('data-action');

                if (action === 'delete') {
                    if (tbody.rows.length > 1) row.remove();
                } else if (action === 'duplicate') {
                    const clone = row.cloneNode(true);
                    const origInputs = row.querySelectorAll('wa-input, r-combobox');
                    const cloneInputs = clone.querySelectorAll('wa-input, r-combobox');
                    origInputs.forEach((input, i) => {
                        cloneInputs[i].setAttribute('value', getInputValue(input));
                    });
                    row.parentNode.insertBefore(clone, row.nextSibling);
                    setupRow(clone);
                }
            });
        };

        document.addEventListener('customerSelected', ({detail}) => {
            document.getElementById('customerId').value = detail.id;
        });

        document.addEventListener('DOMContentLoaded', initInvoiceForm);
    </script>
</th:block>
</body>
</html>
