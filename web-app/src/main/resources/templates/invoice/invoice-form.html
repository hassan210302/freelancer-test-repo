<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<body>

<main layout:fragment="content">
    <wa-tab-group>
        <wa-tab panel="details">Details</wa-tab>
        <wa-tab panel="sending">Sending</wa-tab>
        <wa-tab-panel name="details">
            <div class="wa-stack">
                <wa-card>1</wa-card>
                <wa-card>2</wa-card>
                <wa-card>
                    <div slot="header" class="wa-split">
                        Lines
                    </div>

                    <table id="invoiceTable" border="1">
                        <thead>
                        <tr>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Discount (%)</th>
                            <th>VAT (%)</th>
                            <th>Amount (Incl. VAT)</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="invoiceBody">
                        <tr>
                            <td>
                                <wa-input name="productName" size="small" style="width: 400px;"></wa-input>
                            </td>
                            <td>
                                <wa-input name="quantity" type="number" value="1" size="small" style="width: 80px;"></wa-input>
                            </td>
                            <td>
                                <wa-input name="unitPrice" type="number" value="0" size="small" style="width: 120px;"></wa-input>
                            </td>
                            <td>
                                <wa-input name="discount" type="number" value="0" size="small" style="width: 80px;"></wa-input>
                            </td>
                            <td>
                                <wa-input name="vat" type="number" value="0" size="small" style="width: 80px;"></wa-input>
                            </td>
                            <td class="amount">0.00</td>
                            <td>
                                <wa-button size="small" variant="neutral" onclick="duplicateRow(this)">
                                    <wa-icon name="copy" variant="solid" title="Duplicate"></wa-icon>
                                </wa-button>
                                <wa-button size="small" variant="danger" onclick="deleteRow(this)">
                                    <wa-icon name="trash" variant="solid" title="Delete"></wa-icon>
                                </wa-button>
                            </td>
                        </tr>
                        </tbody>
                        <tfoot>
                        <tr>
                            <td colspan="7" style="text-align: left;">
                                <button type="button" onclick="addRow()">+ Add Row</button>
                            </td>
                        </tr>
                        </tfoot>
                    </table>
                </wa-card>
            </div>
        </wa-tab-panel>
        <wa-tab-panel name="sending">This is the sending tab panel.</wa-tab-panel>
    </wa-tab-group>

</main>

<th:block layout:fragment="scripts">
    <script>
        function getValue(row, name) {
            const input = row.querySelector(`wa-input[name="${name}"]`);
            return parseFloat(input?.value || input?.getAttribute("value") || 0);
        }

        function updateAmount(el) {
            const row = el.closest('tr');
            const qty = getValue(row, 'quantity');
            const price = getValue(row, 'unitPrice');
            const discount = getValue(row, 'discount');
            const vat = getValue(row, 'vat');

            const discounted = price * (1 - discount / 100);
            const subtotal = qty * discounted;
            const totalWithVat = subtotal * (1 + vat / 100);

            row.querySelector('.amount').textContent = totalWithVat.toFixed(2);
        }

        function attachEvents(row) {
            row.querySelectorAll('wa-input').forEach(input => {
                input.addEventListener('input', () => updateAmount(input));
            });
            // Initial calculation on attach
            updateAmount(row.querySelector('wa-input'));
        }

        function deleteRow(icon) {
            const tbody = icon.closest('tbody');
            const rows = tbody.querySelectorAll('tr');
            if (rows.length > 1) {
                const row = icon.closest('tr');
                row.remove();
            } else {
                alert("Cannot delete the last remaining row.");
            }
        }

        function duplicateRow(icon) {
            const originalRow = icon.closest('tr');
            const newRow = originalRow.cloneNode(false); // clone row only

            originalRow.querySelectorAll('td').forEach(td => {
                const newTd = td.cloneNode(false);
                const waInput = td.querySelector('wa-input');

                if (waInput) {
                    const inputClone = waInput.cloneNode(true);
                    // copy current live value to new input's value attribute
                    inputClone.setAttribute('value', waInput.value || waInput.getAttribute('value') || '');
                    newTd.appendChild(inputClone);
                } else {
                    newTd.innerHTML = td.innerHTML; // amount and actions
                }
                newRow.appendChild(newTd);
            });

            attachEvents(newRow);
            originalRow.parentNode.insertBefore(newRow, originalRow.nextSibling);
        }

        function addRow() {
            const rowTemplate = document.querySelector('#invoiceBody tr');
            const clone = rowTemplate.cloneNode(true);
            clone.querySelectorAll('wa-input').forEach(input => {
                const name = input.getAttribute('name');
                if (name === 'quantity') input.setAttribute('value', '1');
                else if (name === 'discount') input.setAttribute('value', '0'); // zero discount
                else input.setAttribute('value', '0');
            });
            clone.querySelector('.amount').textContent = '0.00';
            attachEvents(clone);
            document.querySelector('#invoiceBody').appendChild(clone);
        }


        // Initialize event listeners and calculation for all existing rows on page load
        document.querySelectorAll('#invoiceBody tr').forEach(row => attachEvents(row));

    </script>
</th:block>
</body>
</html>
