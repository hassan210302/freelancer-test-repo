<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <th:block th:replace="~{fragments/r-combobox :: r-combobox-dependencies}"></th:block>
</head>
<body>
<main layout:fragment="content">
    <wa-tab-group>
        <wa-tab panel="details">Details</wa-tab>
        <wa-tab panel="sending">Sending</wa-tab>
        <wa-tab-panel name="details">
            <div class="wa-stack">
                <wa-card>
                    <div slot="header" class="wa-split">
                        Customer
                    </div>
                    <div style="max-width: 300px">
                        <div th:replace="fragments/customer-search :: customerSearch"></div>
                    </div>
                </wa-card>
                <wa-card>
                    <div slot="header" class="wa-split">
                        Date
                    </div>
                    <wa-input id="daysUntilDue" name="daysUntilDue" value="0" min="0" size="small"
                              label="days until due" type="number"
                              style="width: 300px">
                    </wa-input>
                </wa-card>
                <wa-card>
                    <div slot="header" class="wa-split">
                        Lines
                    </div>
                    <table id="invoiceTable" border="1">
                        <thead>
                        <tr>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Discount (%)</th>
                            <th>VAT (%)</th>
                            <th>Amount (Incl. VAT)</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="invoiceBody">
                        <tr>
                            <td>
                                <wa-input name="productName" size="small" style="width: 300px;"></wa-input>
                            </td>
                            <td>
                                <wa-input name="quantity" min="0" type="number" value="1" size="small"
                                          style="width: 80px;"></wa-input>
                            </td>
                            <td>
                                <wa-input name="unitPrice" type="number" value="0" size="small"
                                          style="width: 120px;"></wa-input>
                            </td>
                            <td>
                                <wa-input name="discount" min="0" type="number" value="0" size="small"
                                          style="width: 80px;"></wa-input>
                            </td>
                            <td>
                                <r-combobox
                                        name="vat"
                                        placeholder="Select VAT code..."
                                        style="font-size: var(--wa-font-size-xs);">
                                </r-combobox>
                                <wa-input name="hidden-vat" type="number" value="0"
                                          class="wa-visually-hidden" tabindex="-1"></wa-input>
                            </td>
                            <td class="amount">0.00</td>
                            <td>
                                <wa-button size="small" variant="neutral" onclick="duplicateRow(this)">
                                    <wa-icon name="copy" variant="solid" title="Duplicate"></wa-icon>
                                </wa-button>
                                <wa-button size="small" variant="danger" onclick="deleteRow(this)">
                                    <wa-icon name="trash" variant="solid" title="Delete"></wa-icon>
                                </wa-button>
                            </td>
                        </tr>
                        </tbody>
                        <tfoot>
                        <tr>
                            <td colspan="7" style="text-align: left;">
                                <button type="button" onclick="addRow()">+ Add Row</button>
                            </td>
                        </tr>
                        </tfoot>
                    </table>
                </wa-card>
            </div>
        </wa-tab-panel>
        <wa-tab-panel name="sending">This is the sending tab panel.</wa-tab-panel>
    </wa-tab-group>

</main>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        let vatCodes = [];
    </script>
    <script th:src="@{/assets/cache-config.js}"></script>
    <script th:src="@{/assets/vat-codes.js}"></script>
    <script th:src="@{/assets/fragments/customer-search.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('daysUntilDue');
            if (!input) return;
            const updateLabel = () => {
                const days = parseInt(input.value, 10) || 0;
                const futureDate = new Date();
                futureDate.setDate(futureDate.getDate() + days);
                const formattedDate = futureDate.toLocaleDateString();
                input.setAttribute('label', `days until due: ${formattedDate}`);
            };
            input.addEventListener('input', updateLabel);
            updateLabel();
        });
    </script>
    <script>
        async function initializeExistingPostingComboboxes() {
            try {
                const vatCodes = await window.getVatCodes();
                const vatItems = vatCodes.map(vat => ({
                    value: vat.code,
                    title: vat.code,
                    subtitle: '(' + vat.rate + '%) - ' + vat.description,
                    displayText: vat.code + ' (' + vat.rate + '%) - ' + vat.description
                }));

                document.querySelectorAll('r-combobox').forEach(combobox => {
                    combobox.items = vatItems;
                    combobox.addEventListener('change', (e) => {
                        const row = e.target.closest('tr');
                        const input = row.querySelector('wa-input[name="hidden-vat"]');
                        console.log(vatCodes);
                        input.value = vatCodes.find(v => v.code === e.detail.value).rate;
                        updateAmount(row);
                    });
                });
            } catch (error) {
                console.error('Error initializing posting comboboxes:', error);
            }
        }

        window.addEventListener('vat-codes-cached', (e) => {
            initializeExistingPostingComboboxes();
        });

        document.addEventListener('DOMContentLoaded', async function () {
            await initializeExistingPostingComboboxes();
        });
    </script>
    <script>
        const tbody = document.getElementById('invoiceBody');

        function getValue(row, name) {
            const input = row.querySelector(`wa-input[name*="${name}"]`);
            return parseFloat(input?.value || input?.getAttribute('value') || 0);
        }

        function updateAmount(row) {
            const qty = getValue(row, 'quantity');
            const price = getValue(row, 'unitPrice');
            const discount = getValue(row, 'discount');
            const vat = getValue(row, 'hidden-vat');

            const discounted = price * (1 - discount / 100);
            const subtotal = qty * discounted;
            const total = subtotal * (1 + vat / 100);

            row.querySelector('.amount').textContent = total.toFixed(2);
        }

        tbody.addEventListener('input', e => {
            if (e.target.tagName.toLowerCase() === 'wa-input') {
                const row = e.target.closest('tr');
                updateAmount(row);
            }
        });

        function deleteRow(icon) {
            const rows = tbody.querySelectorAll('tr');
            if (rows.length > 1) {
                icon.closest('tr').remove();
            } else {
                alert("Cannot delete the last remaining row.");
            }
        }

        function duplicateRow(icon) {
            const original = icon.closest('tr');
            const clone = original.cloneNode(true);

            original.querySelectorAll('wa-input').forEach((input, i) => {
                const cloneInput = clone.querySelectorAll('wa-input')[i];
                cloneInput.setAttribute('value', input.value || input.getAttribute('value') || '');
            });
            original.querySelectorAll('r-combobox').forEach((input, i) => {
                const cloneInput = clone.querySelectorAll('r-combobox')[i];
                cloneInput.setAttribute('value', input.value || input.getAttribute('value') || '');
            });

            tbody.insertBefore(clone, original.nextSibling);
            updateAmount(clone);
            initializeExistingPostingComboboxes()
        }

        function addRow() {
            const template = tbody.querySelector('tr');
            const clone = template.cloneNode(true);

            clone.querySelectorAll('wa-input').forEach(input => {
                const name = input.getAttribute('name');
                if (name.includes('quantity')) input.setAttribute('value', '1');
                else if (name.includes('discount')) input.setAttribute('value', '0');
                else if (name.includes('productName')) input.setAttribute('value', '');
                else input.setAttribute('value', '0');
            });

            clone.querySelector('.amount').textContent = '0.00';
            tbody.appendChild(clone);
            updateAmount(clone);
            initializeExistingPostingComboboxes()
        }

        tbody.querySelectorAll('tr').forEach(updateAmount);
    </script>
</th:block>
</body>
</html>
